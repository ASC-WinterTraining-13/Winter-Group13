#include "param_storage.h"
#include "param_config.h"

// 默认参数值（首次使用或恢复出厂设置时使用）
static const float DEFAULT_PARAMS[15] = {
    // angle_pid (索引 0-2)
    80.0f, 0.0f, 2.0f,
    
    // mode_2_pid (索引 3-5)
    5.0f, 0.1f, 0.0f,
    
    // mode_3_pid (索引 6-8)
    10.0f, 0.05f, 1.0f,
    
    // mode_4_pid (索引 9-11)
    15.0f, 0.2f, 0.5f,
    
    // mode_5_pid (索引 12-14)
    20.0f, 0.15f, 0.8f
};

//-------------------------------------------------------------------------------------------------------------------
// 函数简介     加载默认参数到缓冲区
// 使用示例     load_default();  // 内部函数，用户不直接调用
//-------------------------------------------------------------------------------------------------------------------
static void load_default(void)
{
    for(uint8 i = 0; i < 15; i++)
    {
        flash_union_buffer[i].float_type = DEFAULT_PARAMS[i];
    }
}

//-------------------------------------------------------------------------------------------------------------------
// 函数简介     初始化参数系统
// 使用示例     Param_Init();  // 在 main() 函数开始时调用一次
// 备注信息     首次使用时自动写入默认值，后续启动自动从Flash加载
//-------------------------------------------------------------------------------------------------------------------
void Param_Init(void)
{
    if(flash_check(PARAM_FLASH_SECTION, PARAM_FLASH_PAGE))  // 返回1 = 有数据
    {
        // 从Flash读取到缓冲区
		
		//角度环pid
        flash_read_page_to_buffer(PARAM_FLASH_SECTION, PARAM_FLASH_PAGE);
		Angle_PID.Kp = ANGLE_KP;
		Angle_PID.Ki = ANGLE_KI;
		Angle_PID.Kd = ANGLE_KD;
		
    }
    else  // 返回0 = 没有数据（首次使用）
    {
        // 加载默认值到缓冲区
        load_default();
        
        // 写入Flash
        flash_write_page_from_buffer(PARAM_FLASH_SECTION, PARAM_FLASH_PAGE);
    }
}

//-------------------------------------------------------------------------------------------------------------------
// 函数简介     保存参数到Flash
// 使用示例     Param_Save();  // 在退出参数修改时调用
// 备注信息     将当前缓冲区的数据写入Flash
//-------------------------------------------------------------------------------------------------------------------
void Param_Save(void)
{
    flash_write_page_from_buffer(PARAM_FLASH_SECTION, PARAM_FLASH_PAGE);
}

//-------------------------------------------------------------------------------------------------------------------
// 函数简介     擦除Flash存储区域
// 使用示例     Param_Erase();  // 擦除后下次启动会重新写入默认值
// 备注信息     慎用！会清空所有保存的参数
//-------------------------------------------------------------------------------------------------------------------
void Param_Erase(void)
{
    flash_erase_page(PARAM_FLASH_SECTION, PARAM_FLASH_PAGE);
}
